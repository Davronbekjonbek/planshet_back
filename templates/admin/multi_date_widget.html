<div class="multi-date-container">
    <input type="hidden" name="{{ widget.name }}" id="{{ widget.attrs.id }}" value="{{ widget.value|default:'' }}">
    <div id="calendar-{{ widget.attrs.id }}" class="multi-date-calendar"></div>
    <div class="selected-dates-container">
        <h4>Tanlangan sanalar:</h4>
        <div id="selected-dates-{{ widget.attrs.id }}" class="selected-dates"></div>
        <button type="button" class="btn btn-sm btn-secondary" id="clear-dates-{{ widget.attrs.id }}">
            Hammasini tozalash
        </button>
    </div>
</div>

<script>
(function($) {
    $(document).ready(function() {
        var widgetId = '{{ widget.attrs.id }}';
        var calendar = $('#calendar-' + widgetId);
        var hiddenInput = $('#' + widgetId);
        var selectedDatesContainer = $('#selected-dates-' + widgetId);
        var selectedDates = [];

        // Mavjud sanalarni yuklash
        var initialDates = hiddenInput.val();
        if (initialDates) {
            selectedDates = initialDates.split(',').filter(function(date) {
                return date.trim() !== '';
            });
        }

        // Kalendar sozlamalari
        calendar.datepicker({
            dateFormat: 'yy-mm-dd',
            showOtherMonths: true,
            selectOtherMonths: true,
            changeMonth: true,
            changeYear: true,
            showButtonPanel: true,
            beforeShowDay: function(date) {
                var dateStr = $.datepicker.formatDate('yy-mm-dd', date);
                var isSelected = selectedDates.indexOf(dateStr) !== -1;
                return [true, isSelected ? 'ui-state-active' : '', ''];
            },
            onSelect: function(dateText) {
                var index = selectedDates.indexOf(dateText);
                if (index === -1) {
                    // Sana tanlandi
                    selectedDates.push(dateText);
                } else {
                    // Sana olib tashlandi
                    selectedDates.splice(index, 1);
                }
                updateSelectedDates();
                calendar.datepicker('refresh');
            }
        });

        // Tanlangan sanalarni yangilash
        function updateSelectedDates() {
            selectedDates.sort();
            hiddenInput.val(selectedDates.join(','));

            var html = '';
            selectedDates.forEach(function(date) {
                html += '<span class="selected-date-tag">' +
                       formatDate(date) +
                       ' <span class="remove-date" data-date="' + date + '">Ã—</span></span>';
            });
            selectedDatesContainer.html(html);
        }

        // Sanani formatlash
        function formatDate(dateStr) {
            var date = new Date(dateStr);
            return date.toLocaleDateString('uz-UZ', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Sanani olib tashlash
        $(document).on('click', '.remove-date', function() {
            var dateToRemove = $(this).data('date');
            var index = selectedDates.indexOf(dateToRemove);
            if (index !== -1) {
                selectedDates.splice(index, 1);
                updateSelectedDates();
                calendar.datepicker('refresh');
            }
        });

        // Hammasini tozalash
        $('#clear-dates-' + widgetId).click(function() {
            selectedDates = [];
            updateSelectedDates();
            calendar.datepicker('refresh');
        });

        // Dastlabki sanalarni ko'rsatish
        updateSelectedDates();
    });
})(django.jQuery);
</script>