{% extends 'monitoring/base.html' %}
{% load static %}
{% load monitoring_tags %}

{% block title %}Viloyatlar bo'yicha taqqoslash{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-map-marked-alt me-2"></i>Viloyatlar bo'yicha narx taqqoslash</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'monitoring:export_excel' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-sm btn-outline-success">
                <i class="fas fa-file-excel me-1"></i>Excel
            </a>
        </div>
    </div>
</div>

<!-- Filter Card -->
<div class="card filter-card mb-4">
    <div class="card-header bg-primary text-white">
        <i class="fas fa-filter me-2"></i>Taqqoslash parametrlari
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-6">
                <label for="id_period" class="form-label">Davr</label>
                <select name="period" id="id_period" class="form-select" required>
                    <option value="">-- Tanlang --</option>
                    {% for period in periods %}
                        <option value="{{ period.id }}" {% if selected_period.id == period.id %}selected{% endif %}>
                            {{ period.date|date:"d.m.Y" }} - {{ period.period.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-6">
                <label for="id_category" class="form-label">Kategoriya</label>
                <select name="category" id="id_category" class="form-select" required>
                    <option value="">-- Tanlang --</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if selected_category.id == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-12 text-end">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-chart-bar me-2"></i>Taqqoslash
                </button>
                <a href="{% url 'monitoring:region_comparison' %}" class="btn btn-secondary">
                    <i class="fas fa-undo me-2"></i>Tozalash
                </a>
            </div>
        </form>
    </div>
</div>

{% if comparison_data %}
<!-- Main Comparison Chart -->
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i>{{ selected_category.name }} - Viloyatlar bo'yicha o'rtacha narxlar ({{ selected_period.date|date:"d.m.Y" }})
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 400px;">
                    <canvas id="regionComparisonChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Comparison Table -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-table me-2"></i>{{ selected_category.name }} - Viloyatlar bo'yicha o'rtacha narxlar jadvali
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover data-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Viloyat</th>
                        <th>O'rtacha narx</th>
                        <th>Farq (o'rtachadan)</th>
                    </tr>
                </thead>
                <tbody>
                    {% with regionData=comparison_data|safe %}
                        {% with regionData_dict=regionData|pdb %}
                            {% for label in regionData_dict.labels %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ label }}</td>
                                    <td class="text-end">
                                        {{ regionData_dict.data|index:forloop.counter0|floatformat:2 }} so'm
                                    </td>
                                    <td>
                                        {% with avg_value=regionData_dict.data|average %}
                                            {% with diff=regionData_dict.data|index:forloop.counter0|subtract:avg_value %}
                                                {% if diff > 0 %}
                                                    <span class="text-danger">+{{ diff|floatformat:2 }} so'm (+{{ diff|div:avg_value|mul:100|floatformat:1 }}%)</span>
                                                {% elif diff < 0 %}
                                                    <span class="text-success">{{ diff|floatformat:2 }} so'm ({{ diff|div:avg_value|mul:100|floatformat:1 }}%)</span>
                                                {% else %}
                                                    <span class="text-muted">0 so'm (0%)</span>
                                                {% endif %}
                                            {% endwith %}
                                        {% endwith %}
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endwith %}
                    {% endwith %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<!-- No data selected -->
<div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>Viloyatlar taqqoslash uchun yuqoridagi parametrlarni tanlang.
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if comparison_data %}
<script>
    // Region Comparison Chart
    var regionCtx = document.getElementById('regionComparisonChart').getContext('2d');
    var regionData = {{ comparison_data|safe }};
    
    // Calculate average for threshold line
    var sum = 0;
    for(var i = 0; i < regionData.data.length; i++) {
        sum += regionData.data[i];
    }
    var avgPrice = sum / regionData.data.length;
    
    // Determine colors based on comparison to average
    var backgroundColors = [];
    var borderColors = [];
    
    for(var i = 0; i < regionData.data.length; i++) {
        if(regionData.data[i] > avgPrice) {
            // Higher than average - red
            backgroundColors.push('rgba(231, 76, 60, 0.7)');
            borderColors.push('rgba(231, 76, 60, 1)');
        } else if(regionData.data[i] < avgPrice) {
            // Lower than average - green
            backgroundColors.push('rgba(46, 204, 113, 0.7)');
            borderColors.push('rgba(46, 204, 113, 1)');
        } else {
            // Equal to average - blue
            backgroundColors.push('rgba(52, 152, 219, 0.7)');
            borderColors.push('rgba(52, 152, 219, 1)');
        }
    }
    
    var regionComparisonChart = new Chart(regionCtx, {
        type: 'bar',
        data: {
            labels: regionData.labels,
            datasets: [{
                label: 'O\'rtacha narx',
                data: regionData.data,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Narx (so\'m)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Viloyat'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: '{{ selected_category.name }} - Viloyatlar bo\'yicha o\'rtacha narxlar'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            var value = context.parsed.y;
                            var diff = value - avgPrice;
                            var percentDiff = (diff / avgPrice) * 100;
                            
                            var label = context.dataset.label + ': ' + value.toFixed(2) + ' so\'m';
                            
                            if(diff !== 0) {
                                label += ' (' + (diff > 0 ? '+' : '') + diff.toFixed(2) + ' so\'m, ' + 
                                        (diff > 0 ? '+' : '') + percentDiff.toFixed(1) + '% o\'rtachadan)';
                            }
                            
                            return label;
                        }
                    }
                },
                annotation: {
                    annotations: {
                        line1: {
                            type: 'line',
                            yMin: avgPrice,
                            yMax: avgPrice,
                            borderColor: 'rgba(0, 0, 0, 0.5)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                content: 'O\'rtacha: ' + avgPrice.toFixed(2) + ' so\'m',
                                enabled: true,
                                position: 'end'
                            }
                        }
                    }
                }
            }
        }
    });
</script>
{% endif %}
{% endblock %}