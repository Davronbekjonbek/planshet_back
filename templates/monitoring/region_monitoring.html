{% extends 'monitoring/base.html' %}
{% load static %}
{% load monitoring_tags %}
{% load l10n %}

{% block title %}Viloyatlar bo'yicha taqqoslash{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-chart-pie me-2"></i>Viloyatlar bo'yicha monitoring</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="?{{ request.GET.urlencode }}&export=excel" class="btn btn-sm btn-outline-success">
                <i class="fas fa-file-excel me-1"></i>Excel
            </a>
        </div>
    </div>
</div>

<!-- Filter Card -->
<div class="card filter-card mb-4">
    <div class="card-header bg-primary text-white">
        <i class="fas fa-filter me-2"></i>Filtrlash
    </div>
    <div class="card-body">
        <form method="get" id="filterForm" class="row g-3">
            <div class="col-md-3">
                <label for="id_period" class="form-label">Davr (Period)</label>
                <select name="period" id="id_period" class="form-select" onchange="this.form.submit()">
                    <option value="">-- Tanlang --</option>
                    {% for period in periods %}
                    <option value="{{ period.id }}" {% if selected_period.id == period.id %}selected{% endif %}>
                        {{ period.name }} ({{ period.get_period_type_display }})
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label for="id_date" class="form-label">Sana (Period Date)</label>
                <select name="date" id="id_date" class="form-select" onchange="this.form.submit()">
                    <option value="">-- Barcha sanalar --</option>
                    {% for pdate in period_dates %}
                    <option value="{{ pdate.id }}" {% if selected_date.id == pdate.id %}selected{% endif %}>
                        {{ pdate.date|date:"d.m.Y" }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label for="id_region" class="form-label">Viloyat</label>
                <select name="region" id="id_region" class="form-select" onchange="handleRegionChange(this)">
                    <option value="">-- Barcha viloyatlar --</option>
                    {% for region in regions %}
                    <option value="{{ region.id }}" {% if selected_region == region.id %}selected{% endif %}>
                        {{ region.name }} - {{ region.code }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3" id="district_div" {% if not selected_region %}style="display:none;"{% endif %}>
                <label for="id_district" class="form-label">Tuman</label>
                <select name="district" id="id_district" class="form-select" onchange="this.form.submit()">
                    <option value="">-- Barcha tumanlar --</option>
                    {% for district in districts %}
                    <option value="{{ district.id }}" {% if selected_district == district.id %}selected{% endif %}>
                        {{ district.name }} - {{ district.code }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label for="id_status" class="form-label">Status</label>
                <select name="status" id="id_status" class="form-select" onchange="this.form.submit()">
                    <option value="">-- Barcha statuslar --</option>
                    <option value="bg-success" {% if selected_status == 'bg-success' %}selected{% endif %}>To'liq (100%)</option>
                    <option value="bg-warning" {% if selected_status == 'bg-warning' %}selected{% endif %}>Yaxshi (70-99%)</option>
                    <option value="bg-danger" {% if selected_status == 'bg-danger' %}selected{% endif %}>Qoniqarsiz (<70%)</option>
                </select>
            </div>
        </form>
    </div>
</div>

<!-- Data Table -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-table me-2"></i>Natijalar
        {% if mode == 'region' %}(Viloyatlar kesimida)
        {% elif mode == 'district' %}(Tumanlar kesimida)
        {% elif mode == 'tochka' %}(Obyektlar kesimida)
        {% else %}({{ selected_tochka.name }}){% endif %}
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover" id="monitoringTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nomi</th>
                        {% if mode == 'product' %}
                            <th>Kod</th>
                            <th>Narx</th>
                            <th>Birlik</th>
                            <th>Status</th>
                            <th>Xodim</th>
                        {% else %}
                            <th>SOATO</th>
                            {% if mode == 'tochka' %}
                                <th>Jami mahsulotlar</th>
                                <th>Kiritilgan mahsulotlar</th>
                            {% else %}
                                <th>Jami obyektlar</th>
                                <th>Kiritilgan</th>
                            {% endif %}
                            <th>Foiz</th>
                            <th>Status</th>
                            <th>Mas'ul xodimlar</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for item in data %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            {% if mode == 'region' %}
                                <a href="?period={{ selected_period.id }}&date={{ selected_date.id }}&region={{ item.id }}">{{ item.name }}</a>
                            {% elif mode == 'district' %}
                                <a href="?period={{ selected_period.id }}&date={{ selected_date.id }}&region={{ selected_region }}&district={{ item.id }}">{{ item.name }}</a>
                            {% elif mode == 'tochka' %}
                                <a href="?period={{ selected_period.id }}&date={{ selected_date.id }}&region={{ selected_region }}&district={{ selected_district }}&tochka={{ item.id }}">{{ item.name }}</a>
                            {% else %}
                                {{ item.name }}
                            {% endif %}
                        </td>
                        
                        {% if mode == 'product' %}
                            <td>{{ item.soato }}</td>
                            <td>{{ item.price }}</td>
                            <td>{{ item.unit }}</td>
                            <td>
                                <span class="badge {{ item.status_class }}">
                                    {{ item.status_text }}
                                </span>
                            </td>
                            <td>
                                {% if item.employees %}
                                    {{ item.employees.0.full_name }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        {% else %}
                            <td>{{ item.soato }}</td>
                            <td>{{ item.total }}</td>
                            <td>{{ item.entered }}</td>
                            <td style="width: 20%;">
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar {{ item.status_class }}" role="progressbar" 
                                         style="width: {{ item.percent|unlocalize }}%;" 
                                         aria-valuenow="{{ item.percent|unlocalize }}" aria-valuemin="0" aria-valuemax="100">
                                        {{ item.percent }}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge {{ item.status_class }}">
                                    {{ item.status_text }}
                                </span>
                            </td>
                            <td>
                                {% if item.employees %}
                                    <div class="employee-list" data-bs-toggle="tooltip" data-bs-html="true" 
                                         title="{% for emp in item.employees %}{{ emp.full_name }}<br>{% endfor %}">
                                        {{ item.employees|length }} ta xodim
                                        <i class="fas fa-info-circle text-muted ms-1"></i>
                                    </div>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        {% endif %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{% if mode == 'product' %}7{% else %}8{% endif %}" class="text-center">Ma'lumot topilmadi</td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if total_data %}
                <tfoot>
                    <tr class="table-secondary fw-bold">
                        <td colspan="3" class="text-end">Jami:</td>
                        <td>{{ total_data.total }}</td>
                        <td>{{ total_data.entered }}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar {{ total_data.status_class }}" role="progressbar" 
                                     style="width: {{ total_data.percent|unlocalize }}%;" 
                                     aria-valuenow="{{ total_data.percent|unlocalize }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ total_data.percent }}%
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge {{ total_data.status_class }}">
                                {{ total_data.status_text }}
                            </span>
                        </td>
                        <td></td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function handleRegionChange(select) {
        const form = document.getElementById('filterForm');
        const districtSelect = document.getElementById('id_district');
        const districtDiv = document.getElementById('district_div');
        
        // Reset district
        if (districtSelect) {
            districtSelect.value = '';
        }
        
        // Hide district div immediately if no region selected
        if (!select.value) {
            if (districtDiv) districtDiv.style.display = 'none';
        }
        
        form.submit();
    }

    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>
{% if comparison_data %}
<script>
    // Region Comparison Chart
    var regionCtx = document.getElementById('regionComparisonChart').getContext('2d');
    var regionData = {{ comparison_data|safe }};
    
    // Calculate average for threshold line
    var sum = 0;
    for(var i = 0; i < regionData.data.length; i++) {
        sum += regionData.data[i];
    }
    var avgPrice = sum / regionData.data.length;
    
    // Determine colors based on comparison to average
    var backgroundColors = [];
    var borderColors = [];
    
    for(var i = 0; i < regionData.data.length; i++) {
        if(regionData.data[i] > avgPrice) {
            // Higher than average - red
            backgroundColors.push('rgba(231, 76, 60, 0.7)');
            borderColors.push('rgba(231, 76, 60, 1)');
        } else if(regionData.data[i] < avgPrice) {
            // Lower than average - green
            backgroundColors.push('rgba(46, 204, 113, 0.7)');
            borderColors.push('rgba(46, 204, 113, 1)');
        } else {
            // Equal to average - blue
            backgroundColors.push('rgba(52, 152, 219, 0.7)');
            borderColors.push('rgba(52, 152, 219, 1)');
        }
    }
    
    var regionComparisonChart = new Chart(regionCtx, {
        type: 'bar',
        data: {
            labels: regionData.labels,
            datasets: [{
                label: 'O\'rtacha narx',
                data: regionData.data,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Narx (so\'m)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Viloyat'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: '{{ selected_category.name }} - Viloyatlar bo\'yicha o\'rtacha narxlar'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            var value = context.parsed.y;
                            var diff = value - avgPrice;
                            var percentDiff = (diff / avgPrice) * 100;
                            
                            var label = context.dataset.label + ': ' + value.toFixed(2) + ' so\'m';
                            
                            if(diff !== 0) {
                                label += ' (' + (diff > 0 ? '+' : '') + diff.toFixed(2) + ' so\'m, ' + 
                                        (diff > 0 ? '+' : '') + percentDiff.toFixed(1) + '% o\'rtachadan)';
                            }
                            
                            return label;
                        }
                    }
                },
                annotation: {
                    annotations: {
                        line1: {
                            type: 'line',
                            yMin: avgPrice,
                            yMax: avgPrice,
                            borderColor: 'rgba(0, 0, 0, 0.5)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                content: 'O\'rtacha: ' + avgPrice.toFixed(2) + ' so\'m',
                                enabled: true,
                                position: 'end'
                            }
                        }
                    }
                }
            }
        }
    });
</script>
{% endif %}
{% endblock %}